<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.edu.fudan.issueservice.mapper.IssueScanMapper">

    <resultMap id="issueScan" type="cn.edu.fudan.issueservice.domain.dbo.IssueScan">
        <id property="uuid" column="uuid"/>
        <result property="tool" column="tool"/>
        <result property="repoUuid" column="repo_uuid"/>
        <result property="commitId" column="commit_id"/>
        <result property="status" column="status"/>
        <result property="startTime" column="start_time"/>
        <result property="endTime" column="end_time"/>
        <result property="commitTime" column="commit_time"/>
        <result property="resultSummary" column="result_summary"/>
    </resultMap>

    <insert id="insertOneScan" parameterType="cn.edu.fudan.issueservice.domain.dbo.IssueScan">
        insert into issue_scan
        (uuid,
         tool,
         start_time,
         end_time,
         repo_uuid,
         status,
         commit_id,
         commit_time,
         result_summary)
        VALUES (#{uuid},
                #{tool},
                #{startTime},
                #{endTime},
                #{repoId},
                #{status},
                #{commitId},
                #{commitTime},
                #{resultSummary})

    </insert>

    <delete id="deleteIssueScanByRepoIdAndTool" parameterType="String">
        delete
        from issue_scan
        where repo_uuid = #{repo_uuid}
          and tool = #{tool}
    </delete>

    <select id="getIssueScanByRepoIdAndStatusAndTool" resultMap="issueScan">
        select * from issue_scan
        <where>
            repo_uuid=#{repo_uuid}
            <if test="statusList != null and statusList.size > 0">
                and status in
                <foreach collection="statusList" separator="," open="(" close=")" item="status">
                    #{status}
                </foreach>
            </if>
            <if test="tool != null and tool != ''">
                and tool=#{tool}
            </if>
        </where>
        order by commit_id collate utf8mb4_bin
    </select>

    <select id="getIssueScanByRepoIdAndCommitIdAndTool" parameterType="String" resultMap="issueScan">
        select * from issue_scan
        <where>
            repo_uuid=#{repo_uuid}
            <if test="commit_id != null and commit_id != ''">
                and commit_id=#{commit_id}
            </if>
            <if test="tool != null and tool != ''">
                and tool=#{tool}
            </if>
            <if test="since != null">
                and <![CDATA[ start_commit_date >= #{since} ]]>
            </if>
            <if test="until != null">
                and <![CDATA[ start_commit_date <= #{until} ]]>
            </if>
        </where>
        order by commit_time
    </select>

    <select id="getLatestIssueScanByRepoIdAndTool" parameterType="String" resultMap="issueScan">
        select * from issue_scan
        <where>
            repo_uuid=#{repo_uuid}
            <if test="tool != null and tool != ''">
                and tool=#{tool}
            </if>
        </where>
        order by commit_time desc
        limit 1
    </select>

    <select id="getScannedCommitList" resultType="String">
        SELECT commit_id FROM issue_scan
        <trim prefix="where" prefixOverrides="and">
            <if test="repoUuid != null and repoUuid != ''">
                and repo_uuid = #{repoUuid}
            </if>
            <if test="tool != null and tool != ''">
                and tool = #{tool}
            </if>
        </trim>
    </select>
</mapper>