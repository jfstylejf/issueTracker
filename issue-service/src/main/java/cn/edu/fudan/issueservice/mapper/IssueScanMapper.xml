<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.edu.fudan.issueservice.mapper.IssueScanMapper">

    <resultMap id="issueScan" type="IssueScan">
        <id property="uuid" column="uuid"/>
        <result property="tool" column="tool"/>
        <result property="repoId" column="repo_id"/>
        <result property="commitId" column="commit_id"/>
        <result property="status" column="status"/>
        <result property="startTime" column="start_time"/>
        <result property="endTime" column="end_time"/>
        <result property="commitTime" column="commit_time"/>
        <result property="resultSummary" column="result_summary"/>
    </resultMap>



    <insert id="insertOneScan" parameterType="IssueScan">
        insert into issue_scan
        (
        uuid,
        tool,
        start_time,
        end_time,
        repo_id,
        status,
        commit_id,
        commit_time,
        result_summary
        )
        VALUES
        (
        #{uuid},
        #{tool},
        #{startTime},
        #{endTime},
        #{repoId},
        #{status},
        #{commitId},
        #{commitTime},
        #{resultSummary}
        )

    </insert>

    <delete id="deleteIssueScanByRepoIdAndTool" parameterType="String">
        delete from issue_scan where repo_id = #{repo_id} and tool = #{tool}
    </delete>

    <select id="getIssueScanByRepoIdAndStatusAndTool"  resultMap="issueScan">
        select * from issue_scan
        <where>
            repo_id=#{repo_id}
            <if test="statusList != null ">
                and status  in
                <foreach collection="statusList" separator="," open="(" close=")" item="status">
                    #{status}
                </foreach>
            </if>
            <if test="tool != null and tool != ''">
                and tool=#{tool}
            </if>
        </where>
        order by commit_id collate utf8mb4_bin
    </select>

    <select id="getIssueScanByRepoIdAndCommitIdAndTool" parameterType="String" resultMap="issueScan">
        select * from issue_scan
        <where>
            repo_id=#{repo_id}
            <if test="commit_id != null and commit_id != ''">
                and commit_id=#{commit_id}
            </if>
            <if test="tool != null and tool != ''">
                and tool=#{tool}
            </if>
            <if test="since != null">
                and <![CDATA[ start_commit_date >= #{since} ]]>
            </if>
            <if test="until != null">
                and <![CDATA[ start_commit_date <= #{until} ]]>
            </if>
        </where>
        order by commit_time
    </select>


    <select id="getLatestIssueScanByRepoIdAndTool" parameterType="String" resultMap="issueScan">
        select * from issue_scan
        <where>
            repo_id=#{repo_id}
            <if test="tool != null and tool != ''">
                and tool=#{tool}
            </if>
        </where>
        order by commit_time desc limit 1
    </select>

</mapper>