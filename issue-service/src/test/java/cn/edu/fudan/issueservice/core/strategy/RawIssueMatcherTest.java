package cn.edu.fudan.issueservice.core.strategy;

import cn.edu.fudan.issueservice.domain.dbo.RawIssue;
import cn.edu.fudan.issueservice.util.AstParserUtil;
import cn.edu.fudan.issueservice.util.SearchUtil;
import com.alibaba.fastjson.JSONArray;
import com.alibaba.fastjson.JSONObject;
import org.junit.Assert;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.junit.runners.JUnit4;
import org.mockito.InjectMocks;
import org.mockito.MockitoAnnotations;

import java.util.HashSet;
import java.util.List;
import java.util.Set;

@RunWith(JUnit4.class)
public class RawIssueMatcherTest {
    @InjectMocks
    private RawIssueMatcher rawIssueMatcher;

    @Before
    public void setUp() {
        MockitoAnnotations.initMocks(this);
    }

    @Test
    public void testMatch() throws Exception {

        String pre = "[{\"issue_id\":\"f1ccd57a-16fb-4c8c-9eba-1a1579659457\",\"file_name\":\"cn.edu.fudan.common.scan-service/src/main/java/cn/edu/fudan/scanservice/tools/FindBugScanOperation.java\",\"realEliminate\":false,\"type\":\"String literals should not be duplicated\",\"uuid\":\"48659c59-b744-4179-a545-c76733665175\",\"tool\":\"sonarqube\",\"code_lines\":0,\"matchResultDTOIndex\":-1,\"repo_id\":\"3ecf804e-0ad6-11eb-bb79-5b7ba969027e\",\"mapped\":false,\"locations\":[{\"file_path\":\"cn.edu.fudan.common.scan-service/src/main/java/cn/edu/fudan/scanservice/tools/FindBugScanOperation.java\",\"start_token\":0,\"code\":\"            return new ScanResult(\\\"findbug\\\",\\\"failed\\\", \\\"analyze failed\\\");\\n\",\"offset\":1,\"bug_lines\":\"215\",\"locationMatchResults\":[],\"start_line\":215,\"uuid\":\"0507c326-8bfb-4f8b-89a8-064c484cc337\",\"end_line\":215,\"rawIssue_id\":\"48659c59-b744-4179-a545-c76733665175\",\"method_name\":\"doScan(ScanInitialInfo)\",\"end_token\":0,\"matched\":false,\"matchedIndex\":-1},{\"file_path\":\"cn.edu.fudan.common.scan-service/src/main/java/cn/edu/fudan/scanservice/tools/FindBugScanOperation.java\",\"start_token\":0,\"code\":\"            return new ScanResult(\\\"findbug\\\",\\\"failed\\\", \\\"compile failed\\\");\\n\",\"offset\":1,\"bug_lines\":\"200\",\"locationMatchResults\":[],\"start_line\":200,\"uuid\":\"2f0c8527-d483-4edf-b630-fb8043a3f090\",\"end_line\":200,\"rawIssue_id\":\"48659c59-b744-4179-a545-c76733665175\",\"method_name\":\"doScan(ScanInitialInfo)\",\"end_token\":0,\"matched\":false,\"matchedIndex\":-1},{\"file_path\":\"cn.edu.fudan.common.scan-service/src/main/java/cn/edu/fudan/scanservice/tools/FindBugScanOperation.java\",\"start_token\":0,\"code\":\"            return new ScanResult(\\\"findbug\\\",\\\"failed\\\", \\\"tool invoke failed\\\");\\n\",\"offset\":1,\"bug_lines\":\"207\",\"locationMatchResults\":[],\"start_line\":207,\"uuid\":\"df1ca60e-93d9-43f7-8daf-b64d8be9d44c\",\"end_line\":207,\"rawIssue_id\":\"48659c59-b744-4179-a545-c76733665175\",\"method_name\":\"doScan(ScanInitialInfo)\",\"end_token\":0,\"matched\":false,\"matchedIndex\":-1}],\"detail\":\"Define a constant instead of duplicating this literal \\\"failed\\\" 3 times.---CRITICAL\",\"rawIssueMatchResults\":[],\"scan_id\":\"ee2c1f92-4037-41c0-8761-739446711d75\",\"commit_id\":\"e12f6cee85c89d14b9de8d94577fe8844d7b3c25\",\"status\":\"add\"},{\"issue_id\":\"3348b749-2a7e-4979-b862-4316abd38d6e\",\"file_name\":\"cn.edu.fudan.common.scan-service/src/main/java/cn/edu/fudan/scanservice/tools/FindBugScanOperation.java\",\"realEliminate\":false,\"type\":\"String literals should not be duplicated\",\"uuid\":\"6d1241d1-5563-41a0-ad22-8032aaf6f7be\",\"tool\":\"sonarqube\",\"code_lines\":0,\"matchResultDTOIndex\":-1,\"repo_id\":\"3ecf804e-0ad6-11eb-bb79-5b7ba969027e\",\"mapped\":false,\"locations\":[{\"file_path\":\"cn.edu.fudan.common.scan-service/src/main/java/cn/edu/fudan/scanservice/tools/FindBugScanOperation.java\",\"start_token\":0,\"code\":\"        return new ScanResult(\\\"findbug\\\",\\\"success\\\", \\\"Scan Success!\\\");\\n\",\"offset\":1,\"bug_lines\":\"218\",\"locationMatchResults\":[],\"start_line\":218,\"uuid\":\"37bc2253-fe30-41a6-a44b-f141cff64b68\",\"end_line\":218,\"rawIssue_id\":\"6d1241d1-5563-41a0-ad22-8032aaf6f7be\",\"method_name\":\"doScan(ScanInitialInfo)\",\"end_token\":0,\"matched\":false,\"matchedIndex\":-1},{\"file_path\":\"cn.edu.fudan.common.scan-service/src/main/java/cn/edu/fudan/scanservice/tools/FindBugScanOperation.java\",\"start_token\":0,\"code\":\"            return new ScanResult(\\\"findbug\\\",\\\"failed\\\", \\\"compile failed\\\");\\n\",\"offset\":1,\"bug_lines\":\"200\",\"locationMatchResults\":[],\"start_line\":200,\"uuid\":\"b6657de9-f43a-40cf-9c4d-3b39dfba033e\",\"end_line\":200,\"rawIssue_id\":\"6d1241d1-5563-41a0-ad22-8032aaf6f7be\",\"method_name\":\"doScan(ScanInitialInfo)\",\"end_token\":0,\"matched\":false,\"matchedIndex\":-1},{\"file_path\":\"cn.edu.fudan.common.scan-service/src/main/java/cn/edu/fudan/scanservice/tools/FindBugScanOperation.java\",\"start_token\":0,\"code\":\"            return new ScanResult(\\\"findbug\\\",\\\"failed\\\", \\\"tool invoke failed\\\");\\n\",\"offset\":1,\"bug_lines\":\"207\",\"locationMatchResults\":[],\"start_line\":207,\"uuid\":\"c9a0b3e0-3cff-4d0e-b3b9-1f6932892355\",\"end_line\":207,\"rawIssue_id\":\"6d1241d1-5563-41a0-ad22-8032aaf6f7be\",\"method_name\":\"doScan(ScanInitialInfo)\",\"end_token\":0,\"matched\":false,\"matchedIndex\":-1},{\"file_path\":\"cn.edu.fudan.common.scan-service/src/main/java/cn/edu/fudan/scanservice/tools/FindBugScanOperation.java\",\"start_token\":0,\"code\":\"            return new ScanResult(\\\"findbug\\\",\\\"failed\\\", \\\"analyze failed\\\");\\n\",\"offset\":1,\"bug_lines\":\"215\",\"locationMatchResults\":[],\"start_line\":215,\"uuid\":\"d8d6f197-e7b9-4ced-b301-85e7052ab32b\",\"end_line\":215,\"rawIssue_id\":\"6d1241d1-5563-41a0-ad22-8032aaf6f7be\",\"method_name\":\"doScan(ScanInitialInfo)\",\"end_token\":0,\"matched\":false,\"matchedIndex\":-1}],\"detail\":\"Define a constant instead of duplicating this literal \\\"findbug\\\" 4 times.---CRITICAL\",\"rawIssueMatchResults\":[],\"scan_id\":\"ee2c1f92-4037-41c0-8761-739446711d75\",\"commit_id\":\"e12f6cee85c89d14b9de8d94577fe8844d7b3c25\",\"status\":\"add\"},{\"issue_id\":\"b3ca77b5-30a0-4c15-87dd-be9986100dac\",\"file_name\":\"cn.edu.fudan.common.scan-service/src/main/java/cn/edu/fudan/scanservice/tools/FindBugScanOperation.java\",\"realEliminate\":false,\"type\":\"String literals should not be duplicated\",\"uuid\":\"bb9fd0d2-de7e-4f22-b54e-2ac937352c31\",\"tool\":\"sonarqube\",\"code_lines\":0,\"matchResultDTOIndex\":-1,\"repo_id\":\"3ecf804e-0ad6-11eb-bb79-5b7ba969027e\",\"mapped\":false,\"locations\":[{\"file_path\":\"cn.edu.fudan.common.scan-service/src/main/java/cn/edu/fudan/scanservice/tools/FindBugScanOperation.java\",\"start_token\":0,\"code\":\"        Iterator<Element> iterator = bugInstance.elementIterator(\\\"SourceLine\\\");\\n\",\"offset\":1,\"bug_lines\":\"94\",\"locationMatchResults\":[],\"start_line\":94,\"uuid\":\"ac69834b-9425-4587-94ec-b284ab17ea43\",\"end_line\":94,\"rawIssue_id\":\"bb9fd0d2-de7e-4f22-b54e-2ac937352c31\",\"method_name\":\"analyzeLocations(String, String, Element, List)\",\"end_token\":0,\"matched\":false,\"matchedIndex\":-1},{\"file_path\":\"cn.edu.fudan.common.scan-service/src/main/java/cn/edu/fudan/scanservice/tools/FindBugScanOperation.java\",\"start_token\":0,\"code\":\"        Element sourceLineInClass = bugInstance.element(\\\"Class\\\").element(\\\"SourceLine\\\");\\n\",\"offset\":1,\"bug_lines\":\"67\",\"locationMatchResults\":[],\"start_line\":67,\"uuid\":\"b51f7eb1-5449-429d-ae81-534c8dd20839\",\"end_line\":67,\"rawIssue_id\":\"bb9fd0d2-de7e-4f22-b54e-2ac937352c31\",\"method_name\":\"analyzeLocations(String, String, Element, List)\",\"end_token\":0,\"matched\":false,\"matchedIndex\":-1},{\"file_path\":\"cn.edu.fudan.common.scan-service/src/main/java/cn/edu/fudan/scanservice/tools/FindBugScanOperation.java\",\"start_token\":0,\"code\":\"        Element sourceLineInMethod = method.element(\\\"SourceLine\\\");\\n\",\"offset\":1,\"bug_lines\":\"98\",\"locationMatchResults\":[],\"start_line\":98,\"uuid\":\"d70bb7cb-9a7e-43a6-895e-ab4697e9684e\",\"end_line\":98,\"rawIssue_id\":\"bb9fd0d2-de7e-4f22-b54e-2ac937352c31\",\"method_name\":\"analyzeLocations(String, String, Element, List)\",\"end_token\":0,\"matched\":false,\"matchedIndex\":-1}],\"detail\":\"Define a constant instead of duplicating this literal \\\"SourceLine\\\" 3 times.---CRITICAL\",\"rawIssueMatchResults\":[],\"scan_id\":\"ee2c1f92-4037-41c0-8761-739446711d75\",\"commit_id\":\"e12f6cee85c89d14b9de8d94577fe8844d7b3c25\",\"status\":\"add\"}]";
        String cur = "[{\"file_name\":\"cn.edu.fudan.common.scan-service/src/main/java/cn/edu/fudan/scanservice/tools/FindBugScanOperation.java\",\"realEliminate\":false,\"type\":\"String literals should not be duplicated\",\"uuid\":\"c4819474-5ad9-48d4-8022-0946322e8fa4\",\"tool\":\"sonarqube\",\"code_lines\":0,\"matchResultDTOIndex\":-1,\"repo_id\":\"3ecf804e-0ad6-11eb-bb79-5b7ba969027e\",\"mapped\":false,\"locations\":[{\"file_path\":\"cn.edu.fudan.common.scan-service/src/main/java/cn/edu/fudan/scanservice/tools/FindBugScanOperation.java\",\"start_token\":0,\"code\":\"        Element sourceLineInClass = bugInstance.element(\\\"Class\\\").element(\\\"SourceLine\\\");\\n\",\"offset\":1,\"bug_lines\":\"67\",\"locationMatchResults\":[],\"start_line\":67,\"uuid\":\"6e455ef0-8889-49c9-9c00-2325b1ee762d\",\"end_line\":67,\"rawIssue_id\":\"c4819474-5ad9-48d4-8022-0946322e8fa4\",\"method_name\":\"analyzeLocations(String, String, Element, List)\",\"end_token\":0,\"matched\":false,\"matchedIndex\":-1},{\"file_path\":\"cn.edu.fudan.common.scan-service/src/main/java/cn/edu/fudan/scanservice/tools/FindBugScanOperation.java\",\"start_token\":0,\"code\":\"        Iterator<Element> iterator = bugInstance.elementIterator(\\\"SourceLine\\\");\\n\",\"offset\":1,\"bug_lines\":\"94\",\"locationMatchResults\":[],\"start_line\":94,\"uuid\":\"907a11a6-1cf0-4a2e-bfa9-00c2eee16d59\",\"end_line\":94,\"rawIssue_id\":\"c4819474-5ad9-48d4-8022-0946322e8fa4\",\"method_name\":\"analyzeLocations(String, String, Element, List)\",\"end_token\":0,\"matched\":false,\"matchedIndex\":-1},{\"file_path\":\"cn.edu.fudan.common.scan-service/src/main/java/cn/edu/fudan/scanservice/tools/FindBugScanOperation.java\",\"start_token\":0,\"code\":\"        Element sourceLineInMethod = method.element(\\\"SourceLine\\\");\\n\",\"offset\":1,\"bug_lines\":\"98\",\"locationMatchResults\":[],\"start_line\":98,\"uuid\":\"afd86ac7-c89e-4222-bb60-105ad12c1d2c\",\"end_line\":98,\"rawIssue_id\":\"c4819474-5ad9-48d4-8022-0946322e8fa4\",\"method_name\":\"analyzeLocations(String, String, Element, List)\",\"end_token\":0,\"matched\":false,\"matchedIndex\":-1}],\"detail\":\"Define a constant instead of duplicating this literal \\\"SourceLine\\\" 3 times.---CRITICAL\",\"rawIssueMatchResults\":[],\"scan_id\":\"sonarqube\",\"commit_id\":\"9365a0a2a94f5ccf3658d3903379fd23cfc1e103\",\"developerName\":\"zhannanjie\",\"status\":\"default\"},{\"file_name\":\"cn.edu.fudan.common.scan-service/src/main/java/cn/edu/fudan/scanservice/tools/FindBugScanOperation.java\",\"realEliminate\":false,\"type\":\"String literals should not be duplicated\",\"uuid\":\"1e6a4903-2a90-4f3a-beed-030de8927a69\",\"tool\":\"sonarqube\",\"code_lines\":0,\"matchResultDTOIndex\":-1,\"repo_id\":\"3ecf804e-0ad6-11eb-bb79-5b7ba969027e\",\"mapped\":false,\"locations\":[{\"file_path\":\"cn.edu.fudan.common.scan-service/src/main/java/cn/edu/fudan/scanservice/tools/FindBugScanOperation.java\",\"start_token\":0,\"code\":\"            return new ScanResult(\\\"findbug\\\",\\\"failed\\\", \\\"compile failed\\\");\\n\",\"offset\":1,\"bug_lines\":\"200\",\"locationMatchResults\":[],\"start_line\":200,\"uuid\":\"6234abcf-9973-4ad9-b22c-292efb5e6be2\",\"end_line\":200,\"rawIssue_id\":\"1e6a4903-2a90-4f3a-beed-030de8927a69\",\"method_name\":\"doScan(ScanInitialInfo)\",\"end_token\":0,\"matched\":false,\"matchedIndex\":-1},{\"file_path\":\"cn.edu.fudan.common.scan-service/src/main/java/cn/edu/fudan/scanservice/tools/FindBugScanOperation.java\",\"start_token\":0,\"code\":\"            return new ScanResult(\\\"findbug\\\",\\\"failed\\\", \\\"tool invoke failed\\\");\\n\",\"offset\":1,\"bug_lines\":\"207\",\"locationMatchResults\":[],\"start_line\":207,\"uuid\":\"817358e5-41a8-4835-a364-3217ad0a6cbd\",\"end_line\":207,\"rawIssue_id\":\"1e6a4903-2a90-4f3a-beed-030de8927a69\",\"method_name\":\"doScan(ScanInitialInfo)\",\"end_token\":0,\"matched\":false,\"matchedIndex\":-1},{\"file_path\":\"cn.edu.fudan.common.scan-service/src/main/java/cn/edu/fudan/scanservice/tools/FindBugScanOperation.java\",\"start_token\":0,\"code\":\"            return new ScanResult(\\\"findbug\\\",\\\"failed\\\", \\\"analyze failed\\\");\\n\",\"offset\":1,\"bug_lines\":\"215\",\"locationMatchResults\":[],\"start_line\":215,\"uuid\":\"75f46c82-d83c-40d8-8a7c-3db415d52347\",\"end_line\":215,\"rawIssue_id\":\"1e6a4903-2a90-4f3a-beed-030de8927a69\",\"method_name\":\"doScan(ScanInitialInfo)\",\"end_token\":0,\"matched\":false,\"matchedIndex\":-1}],\"detail\":\"Define a constant instead of duplicating this literal \\\"failed\\\" 3 times.---CRITICAL\",\"rawIssueMatchResults\":[],\"scan_id\":\"sonarqube\",\"commit_id\":\"9365a0a2a94f5ccf3658d3903379fd23cfc1e103\",\"developerName\":\"zhannanjie\",\"status\":\"default\"},{\"file_name\":\"cn.edu.fudan.common.scan-service/src/main/java/cn/edu/fudan/scanservice/tools/FindBugScanOperation.java\",\"realEliminate\":false,\"type\":\"String literals should not be duplicated\",\"uuid\":\"3b7cbebd-94b4-48c4-b5e6-92349f3ef388\",\"tool\":\"sonarqube\",\"code_lines\":0,\"matchResultDTOIndex\":-1,\"repo_id\":\"3ecf804e-0ad6-11eb-bb79-5b7ba969027e\",\"mapped\":false,\"locations\":[{\"file_path\":\"cn.edu.fudan.common.scan-service/src/main/java/cn/edu/fudan/scanservice/tools/FindBugScanOperation.java\",\"start_token\":0,\"code\":\"            return new ScanResult(\\\"findbug\\\",\\\"failed\\\", \\\"compile failed\\\");\\n\",\"offset\":1,\"bug_lines\":\"200\",\"locationMatchResults\":[],\"start_line\":200,\"uuid\":\"597a2e83-41a7-4302-bab2-305e6995e2ed\",\"end_line\":200,\"rawIssue_id\":\"3b7cbebd-94b4-48c4-b5e6-92349f3ef388\",\"method_name\":\"doScan(ScanInitialInfo)\",\"end_token\":0,\"matched\":false,\"matchedIndex\":-1},{\"file_path\":\"cn.edu.fudan.common.scan-service/src/main/java/cn/edu/fudan/scanservice/tools/FindBugScanOperation.java\",\"start_token\":0,\"code\":\"            return new ScanResult(\\\"findbug\\\",\\\"failed\\\", \\\"tool invoke failed\\\");\\n\",\"offset\":1,\"bug_lines\":\"207\",\"locationMatchResults\":[],\"start_line\":207,\"uuid\":\"0c0b6de5-02e1-4903-b5a5-4a3c06c96211\",\"end_line\":207,\"rawIssue_id\":\"3b7cbebd-94b4-48c4-b5e6-92349f3ef388\",\"method_name\":\"doScan(ScanInitialInfo)\",\"end_token\":0,\"matched\":false,\"matchedIndex\":-1},{\"file_path\":\"cn.edu.fudan.common.scan-service/src/main/java/cn/edu/fudan/scanservice/tools/FindBugScanOperation.java\",\"start_token\":0,\"code\":\"            return new ScanResult(\\\"findbug\\\",\\\"failed\\\", \\\"analyze failed\\\");\\n\",\"offset\":1,\"bug_lines\":\"215\",\"locationMatchResults\":[],\"start_line\":215,\"uuid\":\"dd97b724-be79-48d1-83b4-48c4bb9149b1\",\"end_line\":215,\"rawIssue_id\":\"3b7cbebd-94b4-48c4-b5e6-92349f3ef388\",\"method_name\":\"doScan(ScanInitialInfo)\",\"end_token\":0,\"matched\":false,\"matchedIndex\":-1},{\"file_path\":\"cn.edu.fudan.common.scan-service/src/main/java/cn/edu/fudan/scanservice/tools/FindBugScanOperation.java\",\"start_token\":0,\"code\":\"        return new ScanResult(\\\"findbug\\\",\\\"success\\\", \\\"Scan Success!\\\");\\n\",\"offset\":1,\"bug_lines\":\"218\",\"locationMatchResults\":[],\"start_line\":218,\"uuid\":\"16acd892-fc23-41fb-9af5-d31d4272b7f1\",\"end_line\":218,\"rawIssue_id\":\"3b7cbebd-94b4-48c4-b5e6-92349f3ef388\",\"method_name\":\"doScan(ScanInitialInfo)\",\"end_token\":0,\"matched\":false,\"matchedIndex\":-1}],\"detail\":\"Define a constant instead of duplicating this literal \\\"findbug\\\" 4 times.---CRITICAL\",\"rawIssueMatchResults\":[],\"scan_id\":\"sonarqube\",\"commit_id\":\"9365a0a2a94f5ccf3658d3903379fd23cfc1e103\",\"developerName\":\"zhannanjie\",\"status\":\"default\"}]";

        List<RawIssue> preRawIssueList = JSONObject.parseArray(JSONArray.parseArray(pre).toJSONString(), RawIssue.class);
        List<RawIssue> curRawIssueList = JSONObject.parseArray(JSONArray.parseArray(cur).toJSONString(), RawIssue.class);

        String filePath = "C:\\Users\\Beethoven\\Downloads\\cn.edu.fudan.common.scan-service_src_main_java_cn_edu_fudan_scanservice_tools_FindBugScanOperation.java";

        Set<String> curName = AstParserUtil.getAllMethodAndFieldName(filePath);

        rawIssueMatcher.match(preRawIssueList, curRawIssueList, curName);
        for(RawIssue curRawIssue : curRawIssueList){
            Assert.assertEquals(curRawIssue.getMappedRawIssue().getDetail(), curRawIssue.getDetail());
        }
    }
}
