<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.edu.fudan.measureservice.mapper.MeasureScanMapper">

    <resultMap id="measureScan" type="MeasureScan">
        <id property="uuid" column="uuid"/>
        <result property="repoId" column="repo_id"/>
        <result property="tool" column="tool"/>
        <result property="startCommit" column="start_commit"/>
        <result property="endCommit" column="end_commit"/>
        <result property="totalCommitCount" column="total_commit_count"/>
        <result property="scannedCommitCount" column="scanned_commit_count"/>
        <result property="scanTime" column="scan_time"/>
        <result property="status" column="status"/>
        <result property="startScanTime" column="start_scan_time"/>
        <result property="endScanTime" column="end_scan_time"/>
    </resultMap>

    <insert id="insertOneMeasureScan" parameterType="MeasureScan">
        insert into measure_scan
            (
               uuid,
               repo_id,
               tool,
               start_commit,
               end_commit,
               total_commit_count,
               scanned_commit_count,
               scan_time,
               status,
               start_scan_time,
               end_scan_time
            )
        values
           (
              #{uuid},
              #{repoId},
              #{tool},
              #{startCommit},
              #{endCommit},
              #{totalCommitCount},
              #{scannedCommitCount},
              #{scanTime},
              #{status},
              #{startScanTime},
              #{endScanTime}
           )
    </insert>

    <update id="updateMeasureScan" parameterType="MeasureScan">
        update measure_scan
        <trim prefix="set" suffixOverrides=",">
            <if test="totalCommitCount != null">
                total_commit_count=#{totalCommitCount},
            </if>
            <if test="status != null and status != ''">
                status=#{status},
            </if>
            <if test="scannedCommitCount != null">
                scanned_commit_count=#{scannedCommitCount},
            </if>
            <if test="endCommit != null and endCommit != ''">
                end_commit=#{endCommit},
            </if>
            <if test="scanTime != null">
                scan_time=#{scanTime},
            </if>
            <if test="endScanTime != null">
                end_scan_time=#{endScanTime},
            </if>
        </trim>
        <where>
            uuid = #{uuid}
        </where>
    </update>



    <select id="getDevHistoryCommitInfo" parameterType="String" resultType="java.util.HashMap">
        SELECT
            commit_id,commit_time,developer_name,commit_message,first_parent_commit_id,second_parent_commit_id
        FROM
            repo_measure
        WHERE
            repo_id = #{repo_id}
            and
            DATE(commit_time) BETWEEN #{since} AND #{until}
        ORDER BY
            commit_time
    </select>

    <select id="getCcnByCommitIdAndFilePath" parameterType="String" resultType="Integer">
        SELECT
            ccn
        FROM
            file_measure
        WHERE
            commit_id = #{commit_id}
            and
            file_path = #{file_path}
    </select>

    <select id="getDevHistoryFileInfo" parameterType="String" resultType="java.util.HashMap">
        SELECT
            file_path, commit_id, ccn, diff_ccn, add_lines, del_lines
        FROM
            file_measure
        WHERE
            commit_id = #{commit_id}
    </select>




</mapper>